---
title: 封装一个Redux
date: 2019-08-23
categories:
  - JavaScript
  - React
tags:
  - JavaScript
  - React
---

## 一个普通的 Redux

```js
// main-logic.js
import { createStore } from "redux";

// Action
const increaseAction = { type: "increase" };

// Reducer
function counter(state = { count: 0 }, action) {
  const count = state.count;
  switch (action.type) {
    case "increase":
      return { count: count + 1 };
    default:
      return state;
  }
}

// Store
export const store = createStore(counter);

// Map Redux state to component props
export const getInitState = state => {
  return {
    count: state.count
  };
};

// Map Redux actions to component props
export function actions(dispatch) {
  return {
    onIncreaseClick: () => dispatch(increaseAction)
  };
}
```

```js
// create-logic
import React, { Component } from "react";
import { Provider, connect } from "react-redux";

const HOC = ({ getInitState, actions, store }) => TargetComponnet => {
  const App = connect(
    getInitState,
    actions
  )(TargetComponnet);
  return class CreateLogic extends Component {
    render() {
      return (
        <Provider store={store}>
          <App />
        </Provider>
      );
    }
  };
};

export default HOC;
```

```js
// 使用
import React, { Component } from "react";
import styled from "styled-components";
import CreateLogic from "./logic/create-logic";
import { store, getInitState, actions } from "./logic/main-logic";
import { Button } from "antd";

@CreateLogic(getInitState, actions, store)
export default class ReduxDemo extends Component {
  render() {
    const { count, onIncreaseClick } = this.props;
    return (
      <Content>
        <p>{count}</p>
        <Button onClick={onIncreaseClick}>click</Button>
      </Content>
    );
  }
}

const Content = styled.div`
  padding: 20px;
`;
```

## 改造 Redux

如上代码所示，是一个简单的 Redux 高阶组件，接下来，我们改造的核心思想是使`main-logic.js`更简洁和易读。
我们先来改造`getInitState`,正如方法名`init`,此方法我们只作初始化 Redux 的 state：

```js
// main-logic.js
export const getInitState = () => {
  return {
    count: 0
  };
};
```

```js
// create-logic.js
import React, { Component } from "react";
import { Provider, connect } from "react-redux";

const HOC = ({ getInitState, actions, store }) => TargetComponnet => {
  const mapStateToProps = state => {
    return { ...getInitState(), ...state };
  };
  const App = connect(
    mapStateToProps,
    actions
  )(TargetComponnet);
  return class CreateLogic extends Component {
    render() {
      return (
        <Provider store={store}>
          <App />
        </Provider>
      );
    }
  };
};

export default HOC;
```

`getInitState`方法改好之后，看着这个`createStore`是不是有点不爽，把`main-logic.js`中的`createStore`给挪到高阶组件中去吧，然而`createStore`需要`reducer`,而`reducer`的核心是`(state, action) => newState`，我的思路是，`main-logic.js`中的`actions`只用作普通的 state 数据处理，方法中参数为旧的`state`和`调用函数的入参`,将`reducer`的所有操作都封装到高阶组件中去，以下是初步的方案：

```js
// main-logic.js
// initState
export const getInitState = () => {
  return {
    count: 0,
    number: 222
  };
};

export function actions() {
  return {
    onIncreaseClick,
    setNumber
  };
}
const onIncreaseClick = state => {
  return {
    ...state,
    count: state.count + 1
  };
};
const setNumber = (state, { payload }) => {
  return {
    ...state,
    number: payload[0] + payload[1]
  };
};
```

```js
// createStore-logic.js
import React, { Component } from "react";
import { Provider, connect } from "react-redux";
import { createStore } from "redux";

const HOC = ({ getInitState, actions }) => TargetComponnet => {
  // Reducer
  const actionFuncs = actions() || {};
  function counter(state = getInitState(), action) {
    const { type, ...rest } = action;
    if (actionFuncs[type]) {
      return actionFuncs[type](state, { payload: { ...rest } });
    } else {
      return { ...state };
    }
  }

  // Store
  const store = createStore(counter);

  // 处理actions
  const actionList = dispatch => {
    let obj = {};
    Object.keys(actionFuncs).map(key => {
      obj[key] = (...args) => dispatch({ type: key, ...args });
    });
    return obj;
  };

  const mapStateToProps = state => {
    return { ...getInitState(), ...state };
  };

  const App = connect(
    mapStateToProps,
    actionList
  )(TargetComponnet);
  return class CreateLogic extends Component {
    render() {
      return (
        <Provider store={store}>
          <App />
        </Provider>
      );
    }
  };
};

export default HOC;
```

```js
// index.js
import React, { Component } from "react";
import styled from "styled-components";
import CreateLogic from "./logic/create-logic";
import { getInitState, actions } from "./logic/main-logic";
import { Button } from "antd";

@CreateLogic({ getInitState, actions })
export default class ReduxDemo extends Component {
  componentDidMount = () => {
    console.log(this.props);
  };

  render() {
    const { number, count, onIncreaseClick, setNumber } = this.props;
    console.log(this.props);
    return (
      <Content>
        <p>count:{count}</p>
        <p>number:{number}</p>
        <Button onClick={() => onIncreaseClick(1)}>click</Button>
        <Button onClick={() => setNumber(1, 2)}>setNumber</Button>
      </Content>
    );
  }
}

const Content = styled.div`
  padding: 20px;
`;
```

勉强能用，剩下的之后再优化。:joy::joy::joy::joy:
